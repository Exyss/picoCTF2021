# Some Assembly Required 1

## Overview

* Points: 70
* Category: Web Exploitation
* Author: Sears Schulz

## Description
> http://mercury.picoctf.net:37669/index.html

## Hints

1. None!

## Approach

1. First of all, we have to open the JavaScript code executed on this page (use CTRL+U to find it), then use a [beautifier](https://beautifier.io/) to make it understandable.

2. As we can see, there are a lot of elements defined using weird hexadecimal numbers as names. We have to convert all of them to our own understandable names (you can use 'aaa', 'bbb' or whatever you like). Once we have done that, we should have a [clean and readable version](beautified.js) of the code

3. Then, we have to __understand__ what is this code doing. The code runs the following instructions:
    1. __Declares__ an array containing JS keywords and gibberish strings
    2. __Declares__ a function that fetches an element from the previously declared array (which we will call "ARRAY" from now on)
    3. __Declares and runs__ (notice the '()' used __after__ the declaration!) a function that shuffles the ARRAY
    4. __Declares and runs__ an async function that creates another array
    5. __Declares__ the function that will be executed every time the button gets pressed

4. Due to the presence of two functions being executed after being declared, we can assume that the ARRAY as already been shuffled, so this means we can check the current state of the array from the webpage's console by calling it with the name found in the __original__ JS script (_0x402c), obtaining the following output:
```js
_0x402c = [
    "instance", "copy_char", "43591XxcWUl", "504454llVtzW", "arrayBuffer", "2NIQmVj", "result", "value", "2wfTpTR", "instantiate", "275341bEPcme", "innerHTML", "1195047NznhZg", "1qfevql", "input", "1699808QuoWhA", "Correct!", "check_flag", "Incorrect!", "./JIFxzHyW8W", "23SMpAuA", "802698XOMSrr", "charCodeAt", "474547vVoGDO", "getElementById"
  ]
```
This means we can simplify the code by replacing the original ARRAY with the shuffled one and by removing the shuffling function.

5. We can simplify the code even further by replacing every call to the first declared function with the element that gets returned by it. To achieve this, we can write a [simple Python script](get_elem.py) that can do this for us, so that we have to just pass the hexadecimal argument passed by the JS code itself
```python
ARRAY = [
    "instance", "copy_char", "43591XxcWUl", "504454llVtzW", "arrayBuffer", "2NIQmVj", "result", "value", "2wfTpTR", "instantiate", "275341bEPcme", "innerHTML", "1195047NznhZg", "1qfevql", "input", "1699808QuoWhA", "Correct!", "check_flag", "Incorrect!", "./JIFxzHyW8W", "23SMpAuA", "802698XOMSrr", "charCodeAt", "474547vVoGDO", "getElementById"
  ]

def f(a):
    a = a - 0x1d6
    b = ARRAY[a]
    return b

to_convert = int(input("Insert hex number: "), 16)
print("The element found in ARRAY is: "+f(to_convert))  
```
Once we have replaced this function calls with their returned value, we get a [fully readable version](simplified.js) of the JS code runned by the page

6. Now that we can easily read the code, we can see that the async function fetches data from the page `./JIFxzHyW8W`. If we try to open this page using view-source, we can see the flag near the end of the file.

## Flag

<details>
<summary>Click to view the flag</summary>

__picoCTF{a8bae10f4d9544110222c2d639dc6de6}__
</details>